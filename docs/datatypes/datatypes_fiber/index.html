<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Fiber · ZIO</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="To perform an effect without blocking the current process, you can use fibers, which are a lightweight mechanism for concurrency."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Fiber · ZIO"/><meta property="og:type" content="website"/><meta property="og:url" content="https://zio.dev/"/><meta property="og:description" content="To perform an effect without blocking the current process, you can use fibers, which are a lightweight mechanism for concurrency."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100,"cornerOffset":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/navbar_brand.png" alt="ZIO"/><h2 class="headerTitleWithLogo">ZIO</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/overview/overview_index" target="_self">Overview</a></li><li class="siteNavGroupActive"><a href="/docs/datatypes/datatypes_index" target="_self">Data Types</a></li><li class=""><a href="/docs/interop/interop_index" target="_self">Interop</a></li><li class=""><a href="/docs/usecases/usecases_index" target="_self">Use Cases</a></li><li class=""><a href="/docs/howto/howto_index" target="_self">How to</a></li><li class=""><a href="/docs/resources/resources" target="_self">Resources</a></li><li class=""><a href="/docs/ecosystem/ecosystem" target="_self">Ecosystem</a></li><li class=""><a href="/docs/about/about_index" target="_self">About</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Data Types</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Data Types</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_index">Summary</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/datatypes/datatypes_fiber">Fiber</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_fiberref">FiberRef</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_io">IO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_managed">Managed</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_promise">Promise</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_queue">Queue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_ref">Ref</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_schedule">Schedule</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_semaphore">Semaphore</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_sink">Sink</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_stream">Stream</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_chunk">Chunk</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tarray">TArray</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tmap">TMap</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tpriorityqueue">TPriorityQueue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tpromise">TPromise</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tqueue">TQueue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tref">TRef</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/datatypes_tset">TSet</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Fiber</h1></header><article><div><span><p>To perform an effect without blocking the current process, you can use fibers, which are a lightweight mechanism for concurrency.</p>
<p>You can <code>fork</code> any <code>IO[E, A]</code> to immediately yield an <code>UIO[Fiber[E, A]]</code>. The provided <code>Fiber</code> can be used to <code>join</code> the fiber, which will resume on production of the fiber's value, or to <code>interrupt</code> the fiber, which immediately terminates the fiber and safely releases all resources acquired by the fiber.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio._
</code></pre>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> analyzed =
  <span class="hljs-keyword">for</span> {
    fiber1   &lt;- analyzeData(data).fork  <span class="hljs-comment">// IO[E, Analysis]</span>
    fiber2   &lt;- validateData(data).fork <span class="hljs-comment">// IO[E, Boolean]</span>
    <span class="hljs-comment">// Do other stuff</span>
    valid    &lt;- fiber2.join
    _        &lt;- <span class="hljs-keyword">if</span> (!valid) fiber1.interrupt
                <span class="hljs-keyword">else</span> <span class="hljs-type">IO</span>.unit
    analyzed &lt;- fiber1.join
  } <span class="hljs-keyword">yield</span> analyzed
</code></pre>
<p>On the JVM, fibers will use threads, but will not consume <em>unlimited</em> threads. Instead, fibers yield cooperatively during periods of high-contention.</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span></span>(n: <span class="hljs-type">Int</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Int</span>] =
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-type">IO</span>.succeed(<span class="hljs-number">1</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> {
      fiber1 &lt;- fib(n - <span class="hljs-number">2</span>).fork
      fiber2 &lt;- fib(n - <span class="hljs-number">1</span>).fork
      v2     &lt;- fiber2.join
      v1     &lt;- fiber1.join
    } <span class="hljs-keyword">yield</span> v1 + v2
  }
</code></pre>
<p>The interrupt operation does not resume until the fiber has completed or has been interrupted and all its finalizers have been run. These precise semantics allow construction of programs that do not leak resources.</p>
<p>A more powerful variant of <code>fork</code>, called <code>fork0</code>, allows specification of supervisor that will be passed any non-recoverable errors from the forked fiber, including all such errors that occur in finalizers. If this supervisor is not specified, then the supervisor of the parent fiber will be used, recursively, up to the root handler, which can be specified in <code>Runtime</code> (the default supervisor merely prints the stack trace).</p>
<h2><a class="anchor" aria-hidden="true" id="error-model"></a><a href="#error-model" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Error Model</h2>
<p>The <code>IO</code> error model is simple, consistent, permits both typed errors and termination, and does not violate any laws in the <code>Functor</code> hierarchy.</p>
<p>An <code>IO[E, A]</code> value may only raise errors of type <code>E</code>. These errors are recoverable by using the <code>either</code> method.  The resulting effect cannot fail, because the failure case bas been exposed as part of the <code>Either</code> success case.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> error: <span class="hljs-type">Task</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">IO</span>.fail(<span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">"Some Error"</span>))
<span class="hljs-keyword">val</span> errorEither: <span class="hljs-type">ZIO</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Either</span>[<span class="hljs-type">Throwable</span>, <span class="hljs-type">String</span>]] = error.either
</code></pre>
<p>Separately from errors of type <code>E</code>, a fiber may be terminated for the following reasons:</p>
<ul>
<li>The fiber self-terminated or was interrupted by another fiber. The &quot;main&quot; fiber cannot be interrupted because it was not forked from any other fiber.</li>
<li>The fiber failed to handle some error of type <code>E</code>. This can happen only when an <code>IO.fail</code> is not handled. For values of type <code>UIO[A]</code>, this type of failure is impossible.</li>
<li>The fiber has a defect that leads to a non-recoverable error. There are only two ways this can happen:
<ol>
<li>A partial function is passed to a higher-order function such as <code>map</code> or <code>flatMap</code>. For example, <code>io.map(_ =&gt; throw e)</code>, or <code>io.flatMap(a =&gt; throw e)</code>. The solution to this problem is to not to pass impure functions to purely functional libraries like ZIO, because doing so leads to violations of laws and destruction of equational reasoning.</li>
<li>Error-throwing code was embedded into some value via <code>IO.effectTotal</code>, etc. For importing partial effects into <code>IO</code>, the proper solution is to use a method such as <code>IO.effect</code>, which safely translates exceptions into values.</li>
</ol></li>
</ul>
<p>When a fiber is terminated, the reason for the termination, expressed as a <code>Throwable</code>, is passed to the fiber's supervisor, which may choose to log, print the stack trace, restart the fiber, or perform some other action appropriate to the context.</p>
<p>A fiber cannot stop its own interruption. However, all finalizers will be run during termination, even when some finalizers throw non-recoverable errors. Errors thrown by finalizers are passed to the fiber's supervisor.</p>
<p>There are no circumstances in which any errors will be &quot;lost&quot;, which makes the <code>IO</code> error model more diagnostic-friendly than the <code>try</code>/<code>catch</code>/<code>finally</code> construct that is baked into both Scala and Java, which can easily lose errors.</p>
<h2><a class="anchor" aria-hidden="true" id="parallelism"></a><a href="#parallelism" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parallelism</h2>
<p>To execute actions in parallel, the <code>zipPar</code> method can be used:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bigCompute</span></span>(m1: <span class="hljs-type">Matrix</span>, m2: <span class="hljs-type">Matrix</span>, v: <span class="hljs-type">Matrix</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Matrix</span>] =
  <span class="hljs-keyword">for</span> {
    t &lt;- computeInverse(m1).zipPar(computeInverse(m2))
    (i1, i2) = t
    r &lt;- applyMatrices(i1, i2, v)
  } <span class="hljs-keyword">yield</span> r
</code></pre>
<p>The <code>zipPar</code> combinator has resource-safe semantics. If one computation fails, the other computation will be interrupted, to prevent wasting resources.</p>
<h3><a class="anchor" aria-hidden="true" id="racing"></a><a href="#racing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Racing</h3>
<p>Two <code>IO</code> actions can be <em>raced</em>, which means they will be executed in parallel, and the value of the first action that completes successfully will be returned.</p>
<pre><code class="hljs css language-scala">fib(<span class="hljs-number">100</span>) race fib(<span class="hljs-number">200</span>)
</code></pre>
<p>The <code>race</code> combinator is resource-safe, which means that if one of the two actions returns a value, the other one will be interrupted, to prevent wasting resources.</p>
<p>The <code>race</code> and even <code>zipPar</code> combinators are a specialization of a much-more powerful combinator called <code>raceWith</code>, which allows executing user-defined logic when the first of two actions succeeds.</p>
<h2><a class="anchor" aria-hidden="true" id="thread-shifting---jvm"></a><a href="#thread-shifting---jvm" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thread Shifting - JVM</h2>
<p>By default, fibers make no guarantees as to which thread they execute on. They may shift between threads, especially as they execute for long periods of time.</p>
<p>Fibers only ever shift onto the thread pool of the runtime system, which means that by default, fibers running for a sufficiently long time will always return to the runtime system's thread pool, even when their (asynchronous) resumptions were initiated from other threads.</p>
<p>For performance reasons, fibers will attempt to execute on the same thread for a (configurable) minimum period, before yielding to other fibers. Fibers that resume from asynchronous callbacks will resume on the initiating thread, and continue for some time before yielding and resuming on the runtime thread pool.</p>
<p>These defaults help guarantee stack safety and cooperative multitasking. They can be changed in <code>Runtime</code> if automatic thread shifting is not desired.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/datatypes/datatypes_index"><span class="arrow-prev">← </span><span>Summary</span></a><a class="docs-next button" href="/docs/datatypes/datatypes_fiberref"><span class="function-name-prevnext">FiberRef</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#error-model">Error Model</a></li><li><a href="#parallelism">Parallelism</a><ul class="toc-headings"><li><a href="#racing">Racing</a></li></ul></li><li><a href="#thread-shifting---jvm">Thread Shifting - JVM</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/navbar_brand.png" alt="ZIO"/></a><div><h5>GitHub</h5><a href="https://github.com/zio/zio"><img src="https://img.shields.io/github/stars/zio/zio?style=social" alt="github"/></a></div><div><h5>Chat with us on Discord</h5><a href="https://discord.gg/2ccFBr4"><img src="https://img.shields.io/discord/629491597070827530?logo=discord&amp;style=social" alt="discord"/></a></div><div><h5>Follow us on Twitter</h5><a href="https://twitter.com/zioscala"><img src="https://img.shields.io/twitter/follow/zioscala?label=Follow&amp;style=social" alt="twitter"/></a></div><div><h5>Additional resources</h5><a href="https://javadoc.io/doc/dev.zio/zio_2.12/">Scaladoc of zio</a></div><div><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"/></a></div></section><section class="copyright">Copyright © 2020 ZIO Maintainers</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '0c94b59071da7001757d08ab43d9e033',
                indexName: 'zio',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>